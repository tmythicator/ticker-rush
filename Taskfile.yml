version: '3'

dotenv: ['.env']

tasks:
  generate:
    desc: Generate code from SQL and Protobuf
    dir: backend
    cmds:
      - sqlc generate
      # Add protoc command here if needed in the future

  migrate:
    desc: Run database migrations
    dir: backend
    cmds:
      - createdb -h localhost -p {{.POSTGRES_PORT | default "5432"}} -U {{.POSTGRES_USER | default "postgres"}} {{.POSTGRES_DB | default "ticker_rush"}} || true
      - goose -dir db/migrations up
    env:
      GOOSE_DRIVER: postgres
      GOOSE_DBSTRING: 'postgres://{{.POSTGRES_USER | default "postgres"}}:{{.POSTGRES_PASSWORD}}@localhost:{{.POSTGRES_PORT | default "5432"}}/{{.POSTGRES_DB | default "ticker_rush"}}?sslmode=disable'

  build:
    desc: Build the backend services
    dir: backend
    cmds:
      - go build -o exchange cmd/exchange/main.go
      - go build -o fetcher cmd/fetcher/main.go

  test:
    desc: Run all tests
    dir: backend
    cmds:
      - go test -v ./...

  dev:
    desc: Start the development environment
    cmds:
      - process-compose up
